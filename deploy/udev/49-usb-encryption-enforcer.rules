# Block-level read-only enforcement for plaintext USB devices
# Only apply RO to partitions with filesystems, not whole disks or unformatted partitions
# This allows disk management operations (partition create/delete/format) while preventing writes to data

# For partitions with filesystems: mark read-only (exclude LUKS and dm devices)
SUBSYSTEM=="block", ENV{DEVTYPE}=="partition", ENV{ID_BUS}=="usb", \
  ENV{ID_FS_USAGE}=="filesystem", ENV{ID_FS_TYPE}!="", ENV{ID_FS_TYPE}!="crypto_LUKS", \
  ENV{DM_NAME}!="*", ATTR{ro}="1"

# Ensure LUKS devices and dm-crypt mappers remain read-write
SUBSYSTEM=="block", ENV{ID_BUS}=="usb", ENV{ID_FS_TYPE}=="crypto_LUKS", ATTR{ro}="0"
SUBSYSTEM=="block", KERNEL=="dm-*", ATTR{ro}="0"



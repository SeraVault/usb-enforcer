#!/usr/bin/make -f

export DH_VERBOSE = 1
export PYBUILD_DISABLE = 1

%:
	dh $@ --with python3

override_dh_auto_build:
	# Nothing to compile

override_dh_auto_install:
	# Install Python package
	install -d $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/usb-enforcer
	cp -r src/usb_enforcer $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/usb-enforcer/
	install -m 0644 src/usb_enforcer/usb_enforcer_ui.py $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/usb-enforcer/
	
	# Install bundled Python wheels
	install -d $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/usb-enforcer/wheels
	cp wheels/*.whl $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/usb-enforcer/wheels/
	
	# Install executable scripts
	install -d $(CURDIR)/debian/usb-enforcer-bundled/usr/libexec
	install -m 0755 scripts/usb-enforcerd $(CURDIR)/debian/usb-enforcer-bundled/usr/libexec/
	install -m 0755 scripts/usb-enforcer-helper $(CURDIR)/debian/usb-enforcer-bundled/usr/libexec/
	install -m 0755 scripts/usb-enforcer-ui $(CURDIR)/debian/usb-enforcer-bundled/usr/libexec/
	install -m 0755 scripts/usb-enforcer-wizard $(CURDIR)/debian/usb-enforcer-bundled/usr/libexec/
	install -m 0755 scripts/usb-enforcer-cli $(CURDIR)/debian/usb-enforcer-bundled/usr/libexec/
	install -m 0644 scripts/usb-enforcer-cli.py $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/usb-enforcer/
	install -m 0755 scripts/usb-enforcer-notifications $(CURDIR)/debian/usb-enforcer-bundled/usr/libexec/
	
	# Install configuration
	install -d $(CURDIR)/debian/usb-enforcer-bundled/etc/usb-enforcer
	install -m 0644 deploy/config.toml.sample $(CURDIR)/debian/usb-enforcer-bundled/etc/usb-enforcer/config.toml
	
	# Install udev rules
	install -d $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/udev/rules.d
	install -m 0644 deploy/udev/49-usb-enforcer.rules $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/udev/rules.d/
	install -m 0644 deploy/udev/80-udisks2-usb-enforcer.rules $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/udev/rules.d/
	
	# Install polkit rules
	install -d $(CURDIR)/debian/usb-enforcer-bundled/etc/polkit-1/rules.d
	install -m 0644 deploy/polkit/49-usb-enforcer.rules $(CURDIR)/debian/usb-enforcer-bundled/etc/polkit-1/rules.d/
	
	# Install DBus configuration
	install -d $(CURDIR)/debian/usb-enforcer-bundled/etc/dbus-1/system.d
	install -m 0644 deploy/dbus/org.seravault.UsbEnforcer.conf $(CURDIR)/debian/usb-enforcer-bundled/etc/dbus-1/system.d/
	
	# Install systemd units
	install -d $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/systemd/system
	install -m 0644 deploy/systemd/usb-enforcerd.service $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/systemd/system/
	install -d $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/systemd/user
	install -m 0644 deploy/systemd/usb-enforcer-ui.service $(CURDIR)/debian/usb-enforcer-bundled/usr/lib/systemd/user/
	
	# Install icon and desktop file
	install -d $(CURDIR)/debian/usb-enforcer-bundled/usr/share/icons/hicolor/scalable/apps
	install -m 0644 deploy/icons/usb-enforcer.svg $(CURDIR)/debian/usb-enforcer-bundled/usr/share/icons/hicolor/scalable/apps/
	install -d $(CURDIR)/debian/usb-enforcer-bundled/usr/share/applications
	install -m 0644 deploy/desktop/usb-enforcer-wizard.desktop $(CURDIR)/debian/usb-enforcer-bundled/usr/share/applications/
	
	# Install AppStream metadata for package managers
	install -d $(CURDIR)/debian/usb-enforcer-bundled/usr/share/metainfo
	install -m 0644 deploy/appdata/org.seravault.UsbEnforcer.metainfo.xml $(CURDIR)/debian/usb-enforcer-bundled/usr/share/metainfo/
	
	# Install locale files (translations)
	for po in locale/*/LC_MESSAGES/*.po; do \
		[ -e "$$po" ] || continue; \
		mo="$${po%.po}.mo"; \
		if [ ! -f "$$mo" ] || [ "$$po" -nt "$$mo" ]; then \
			msgfmt "$$po" -o "$$mo" 2>/dev/null || true; \
		fi; \
		if [ -f "$$mo" ]; then \
			locale_code=$$(echo "$$po" | cut -d/ -f2); \
			install -d "$(CURDIR)/debian/usb-enforcer-bundled/usr/share/locale/$${locale_code}/LC_MESSAGES"; \
			install -m 0644 "$$mo" "$(CURDIR)/debian/usb-enforcer-bundled/usr/share/locale/$${locale_code}/LC_MESSAGES/usb-enforcer.mo"; \
		fi; \
	done

override_dh_auto_test:
	# Skip tests

override_dh_link:
	dh_link
	# Create CLI symlinks in /usr/bin (after dh_python3 processing)
	dh_link usr/libexec/usb-enforcer-cli usr/bin/usb-enforcer-cli
	dh_link usr/libexec/usb-enforcer-wizard usr/bin/usb-enforcer-wizard

override_dh_auto_clean:
	rm -rf build
	find . -name "*.pyc" -delete
	find . -name "__pycache__" -type d -delete

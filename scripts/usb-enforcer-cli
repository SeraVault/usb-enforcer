#!/bin/bash
# USB Enforcer CLI wrapper
set -e

LIBDIR="/usr/lib/usb-enforcer"
VENV="${LIBDIR}/.venv"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if we're in development mode (script in source tree)
if [ -f "${SCRIPT_DIR}/usb-enforcer-cli.py" ]; then
    # Development mode - run from source directory
    export PYTHONPATH="${SCRIPT_DIR}/../src"
    # Try to use venv if it exists, otherwise system Python
    if [ -d "${VENV}" ] && [ -f "${VENV}/bin/python3" ]; then
        exec "${VENV}/bin/python3" "${SCRIPT_DIR}/usb-enforcer-cli.py" "$@"
    else
        exec python3 "${SCRIPT_DIR}/usb-enforcer-cli.py" "$@"
    fi
# Production mode - installed to /usr/lib
elif [ -f "${LIBDIR}/usb-enforcer-cli.py" ]; then
    export PYTHONPATH="${LIBDIR}"
    if [ -d "${VENV}" ] && [ -f "${VENV}/bin/python3" ]; then
        exec "${VENV}/bin/python3" "${LIBDIR}/usb-enforcer-cli.py" "$@"
    else
        exec python3 "${LIBDIR}/usb-enforcer-cli.py" "$@"
    fi
else
    echo "Error: usb-enforcer-cli.py not found"
    exit 1
fi

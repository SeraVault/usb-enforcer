#!/usr/bin/env bash
# Remove LUKS encryption from a device and format it as exFAT
# WARNING: This will DESTROY ALL DATA on the specified device!

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

usage() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS] DEVICE

Remove LUKS encryption and format device as exFAT.

WARNING: This will DESTROY ALL DATA on the device!

OPTIONS:
    -f, --force         Skip confirmation prompts
    -w, --wipe          Securely wipe entire device (slow)
    -h, --help          Show this help message

ARGUMENTS:
    DEVICE              Device path (e.g., /dev/sdb)

EXAMPLES:
    # Remove encryption and format /dev/sdb as exFAT
    sudo $(basename "$0") /dev/sdb
    
    # Force operation without confirmation
    sudo $(basename "$0") --force /dev/sdb
    
    # Securely wipe device before formatting
    sudo $(basename "$0") --wipe /dev/sdb

EOF
    exit 0
}

log() {
    echo -e "${GREEN}[remove-encryption]${NC} $*"
}

warn() {
    echo -e "${YELLOW}[WARNING]${NC} $*"
}

error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
    exit 1
}

require_root() {
    if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
        error "This script must be run as root"
    fi
}

check_dependencies() {
    local missing=()
    
    for cmd in cryptsetup wipefs lsblk mkfs.exfat parted; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing+=("$cmd")
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        error "Missing required commands: ${missing[*]}"
    fi
}

is_removable() {
    local device="$1"
    local removable_file="/sys/block/$(basename "$device")/removable"
    
    if [[ -f "$removable_file" ]]; then
        local removable=$(cat "$removable_file" 2>/dev/null || echo "0")
        [[ "$removable" == "1" ]]
    else
        return 1
    fi
}

get_device_info() {
    local device="$1"
    
    log "Device information:"
    lsblk -o NAME,SIZE,TYPE,FSTYPE,MOUNTPOINT "$device" 2>/dev/null || true
    
    if is_removable "$device"; then
        log "Device is removable (USB/external)"
    else
        warn "Device does NOT appear to be removable!"
    fi
}

close_luks_containers() {
    local device="$1"
    local base_device=$(basename "$device")
    
    log "Checking for open LUKS containers..."
    
    # Find and close all LUKS containers using this device
    while IFS= read -r dm_name; do
        if [[ -n "$dm_name" ]]; then
            warn "Closing LUKS container: $dm_name"
            cryptsetup close "$dm_name" 2>/dev/null || true
        fi
    done < <(lsblk -nlo NAME,TYPE "$device" 2>/dev/null | awk '$2=="crypt" {print $1}')
    
    # Also check dmsetup for any devices using this
    if command -v dmsetup >/dev/null 2>&1; then
        while IFS= read -r dm_name; do
            if [[ -n "$dm_name" ]]; then
                warn "Closing device mapper: $dm_name"
                dmsetup remove "$dm_name" 2>/dev/null || true
            fi
        done < <(dmsetup ls --target crypt 2>/dev/null | grep -E "^.*${base_device}" | awk '{print $1}' || true)
    fi
}

unmount_partitions() {
    local device="$1"
    
    log "Unmounting any mounted partitions..."
    
    # Unmount all partitions on this device
    while IFS= read -r mountpoint; do
        if [[ -n "$mountpoint" ]]; then
            warn "Unmounting: $mountpoint"
            umount "$mountpoint" 2>/dev/null || true
        fi
    done < <(lsblk -nlo MOUNTPOINT "$device" 2>/dev/null | grep -v '^$' || true)
}

wipe_device() {
    local device="$1"
    local secure="$2"
    
    if [[ "$secure" == "true" ]]; then
        log "Securely wiping device (this may take a while)..."
        dd if=/dev/zero of="$device" bs=1M status=progress || warn "Full wipe failed, continuing..."
    else
        log "Wiping LUKS header and partition table..."
        # Wipe first 10MB (enough for LUKS header and partition table)
        dd if=/dev/zero of="$device" bs=1M count=10 status=progress 2>/dev/null || true
        
        # Wipe last 10MB (backup LUKS header might be here)
        local size=$(blockdev --getsize64 "$device" 2>/dev/null || echo "0")
        if [[ "$size" -gt 10485760 ]]; then
            local offset=$((size - 10485760))
            dd if=/dev/zero of="$device" bs=1M seek=$((offset / 1048576)) count=10 status=progress 2>/dev/null || true
        fi
    fi
    
    # Wipe all filesystem/partition signatures
    wipefs -a "$device" >/dev/null 2>&1 || true
    
    # Tell kernel to re-read partition table
    partprobe "$device" 2>/dev/null || true
    sleep 2
}

create_exfat_partition() {
    local device="$1"
    
    log "Creating new GPT partition table..."
    parted -s "$device" mklabel gpt
    
    log "Creating exFAT partition..."
    parted -s "$device" mkpart primary 1MiB 100%
    
    # Tell kernel to re-read partition table
    partprobe "$device" 2>/dev/null || true
    sleep 2
    
    # Find the first partition
    local partition="${device}1"
    if [[ ! -b "$partition" ]]; then
        # Try alternative naming (e.g., /dev/mmcblk0p1)
        partition="${device}p1"
    fi
    
    if [[ ! -b "$partition" ]]; then
        error "Could not find partition after creation"
    fi
    
    log "Formatting partition as exFAT..."
    mkfs.exfat -n "USB_DRIVE" "$partition"
    
    log "✓ Device formatted successfully as exFAT"
    log ""
    log "Partition layout:"
    lsblk -o NAME,SIZE,TYPE,FSTYPE,LABEL "$device"
}

confirm_operation() {
    local device="$1"
    local force="$2"
    
    if [[ "$force" == "true" ]]; then
        return 0
    fi
    
    echo ""
    warn "═══════════════════════════════════════════════════════════"
    warn "  WARNING: THIS WILL DESTROY ALL DATA ON $device"
    warn "═══════════════════════════════════════════════════════════"
    echo ""
    
    get_device_info "$device"
    
    echo ""
    read -p "Are you ABSOLUTELY SURE you want to continue? Type 'YES' to confirm: " confirmation
    
    if [[ "$confirmation" != "YES" ]]; then
        log "Operation cancelled by user"
        exit 0
    fi
}

main() {
    local device=""
    local force=false
    local secure_wipe=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                usage
                ;;
            -f|--force)
                force=true
                shift
                ;;
            -w|--wipe)
                secure_wipe=true
                shift
                ;;
            -*)
                error "Unknown option: $1"
                ;;
            *)
                if [[ -z "$device" ]]; then
                    device="$1"
                else
                    error "Too many arguments"
                fi
                shift
                ;;
        esac
    done
    
    # Validate device argument
    if [[ -z "$device" ]]; then
        error "Device argument is required. Use --help for usage information."
    fi
    
    # Check if device exists
    if [[ ! -b "$device" ]]; then
        error "Device does not exist: $device"
    fi
    
    # Ensure we have a block device, not a partition
    if [[ "$device" =~ [0-9]$ ]] || [[ "$device" =~ p[0-9]$ ]]; then
        warn "You specified a partition ($device), not a whole device"
        warn "This script should be used on whole devices (e.g., /dev/sdb, not /dev/sdb1)"
        read -p "Continue anyway? (y/N): " cont
        if [[ ! "$cont" =~ ^[Yy]$ ]]; then
            log "Operation cancelled"
            exit 0
        fi
    fi
    
    require_root
    check_dependencies
    confirm_operation "$device" "$force"
    
    log "Starting removal of encryption from $device..."
    
    # Step 1: Close LUKS containers
    close_luks_containers "$device"
    
    # Step 2: Unmount partitions
    unmount_partitions "$device"
    
    # Step 3: Wipe device
    wipe_device "$device" "$secure_wipe"
    
    # Step 4: Create exFAT partition
    create_exfat_partition "$device"
    
    log ""
    log "✓ Operation completed successfully!"
    log ""
    log "The device is now formatted as exFAT and can be used on:"
    log "  • Windows (XP SP2+)"
    log "  • macOS (10.6.5+)"
    log "  • Linux (with exfat-fuse or kernel 5.4+)"
    log ""
    log "You can now safely remove the device."
}

main "$@"
